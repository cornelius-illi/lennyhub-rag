# Qdrant Storage and Persistence

This document explains how Qdrant stores vector data locally, how to back it up, and how to migrate it to other systems.

## Storage Architecture

Qdrant stores all data in the directory specified in [`qdrant_config.yaml`](file:///Users/cornelius/dev/lennyhub-rag/qdrant_config.yaml):

```yaml
storage:
  storage_path: storage/qdrant
```

### Directory Structure

```
storage/qdrant/
├── collections/                    # All vector collections
│   ├── lightrag_vdb_chunks_...    # Text chunks from documents
│   ├── lightrag_vdb_entities_...  # Extracted entities (people, concepts)
│   └── lightrag_vdb_relationships_... # Entity relationships
├── aliases/                        # Collection aliases
├── snapshots/                      # Backup snapshots
├── raft_state.json                # Cluster state (for distributed setups)
├── qdrant.log                     # Server logs
└── qdrant.pid                     # Process ID file
```

### Collection Naming

> [!IMPORTANT]
> Collection names are **auto-generated by LightRAG** and cannot be customized. They follow this pattern:
> ```
> lightrag_vdb_{namespace}_{embedding_model}_{dimensions}d
> ```

For example, with the `text-embedding-3-small` model (1536 dimensions), you'll see:
- `lightrag_vdb_chunks_text_embedding_3_small_1536d`
- `lightrag_vdb_entities_text_embedding_3_small_1536d`
- `lightrag_vdb_relationships_text_embedding_3_small_1536d`

The `QDRANT_COLLECTION_NAME` environment variable is **not used** by LightRAG.

## Collection Structure

Each collection directory contains:

### Configuration Files

- **`config.json`** - Collection settings:
  - Vector dimensions (e.g., 1536 for text-embedding-3-small)
  - Distance metric (Cosine, Euclidean, Dot)
  - HNSW index parameters
  - Optimization settings
  
- **`payload_index.json`** - Indexes for filtering by metadata
- **`shard_key_mapping.json`** - Shard distribution mappings
- **`version.info`** - Collection version number

### Data Storage (Shard Directories)

Each shard (e.g., `0/`) contains:

- **`segments/`** - Multiple UUID-named directories
  - Each segment stores actual vector embeddings and payloads
  - Segments are Qdrant's way of organizing data for efficient search
  - Automatically merged and optimized based on `optimizer_config`

- **`wal/`** - Write-Ahead Log
  - Ensures durability and crash recovery
  - Changes are written here first, then flushed to segments

- **`replica_state.json`** - Replication state
- **`shard_config.json`** - Shard-specific configuration

## Persistence Model

### Automatic Persistence

> [!IMPORTANT]
> Qdrant automatically persists all data to disk. No manual export is required.

Every vector operation (insert, update, delete) follows this flow:

1. **Write to WAL** - Immediate write to Write-Ahead Log for crash safety
2. **Flush to segments** - Periodic flush to segment files (default: every 5 seconds)
3. **Optimization** - Background merging and optimization of segments

### Configuration

Key persistence settings in `config.json`:

```json
{
  "wal_config": {
    "wal_capacity_mb": 32,
    "wal_segments_ahead": 0,
    "wal_retain_closed": 1
  },
  "optimizer_config": {
    "flush_interval_sec": 5,
    "deleted_threshold": 0.2,
    "vacuum_min_vector_number": 1000
  }
}
```

## Backup Strategies

### Option 1: Directory Copy (Simple)

Best for: Development, small datasets, scheduled backups

```bash
# Stop Qdrant for consistency
scripts/qdrant/stop_qdrant.sh

# Create compressed backup
tar -czf qdrant-backup-$(date +%Y%m%d).tar.gz storage/qdrant/

# Restart Qdrant
scripts/qdrant/start_qdrant.sh
```

**Restore:**
```bash
scripts/qdrant/stop_qdrant.sh
rm -rf storage/qdrant/
tar -xzf qdrant-backup-20260122.tar.gz
scripts/qdrant/start_qdrant.sh
```

### Option 2: Qdrant Snapshots (Recommended)

Best for: Production, live systems, no downtime required

```bash
# Create snapshot for a specific collection
curl -X POST "http://localhost:6333/collections/lightrag_vdb_chunks_text_embedding_3_small_1536d/snapshots"

# Response includes snapshot name
# {"result":{"name":"snapshot-2026-01-22-17-30-00.snapshot"},"status":"ok","time":0.123}

# List snapshots
curl "http://localhost:6333/collections/lightrag_vdb_chunks_text_embedding_3_small_1536d/snapshots"

# Download snapshot
curl "http://localhost:6333/collections/lightrag_vdb_chunks_text_embedding_3_small_1536d/snapshots/snapshot-2026-01-22-17-30-00.snapshot" \
  -o snapshot.snapshot
```

**Restore from snapshot:**
```bash
# Upload and restore snapshot
curl -X PUT "http://localhost:6333/collections/lightrag_vdb_chunks_text_embedding_3_small_1536d/snapshots/upload" \
  -H "Content-Type: application/octet-stream" \
  --data-binary @snapshot.snapshot
```

### Option 3: Rsync for Remote Backup

Best for: Continuous backups, remote storage

```bash
# Stop Qdrant first
scripts/qdrant/stop_qdrant.sh

# Sync to remote server
rsync -av --delete storage/qdrant/ user@backup-server:/backups/qdrant/

# Or sync to cloud storage (e.g., S3)
aws s3 sync storage/qdrant/ s3://my-bucket/qdrant-backup/

# Restart Qdrant
scripts/qdrant/start_qdrant.sh
```

## Migration to Another System

### Moving to Another Machine

```bash
# On source machine
scripts/qdrant/stop_qdrant.sh
tar -czf qdrant-data.tar.gz storage/qdrant/

# Transfer to target machine
scp qdrant-data.tar.gz user@target:/path/to/lennyhub-rag/

# On target machine
cd /path/to/lennyhub-rag/
tar -xzf qdrant-data.tar.gz
scripts/qdrant/start_qdrant.sh
```

### Changing Storage Location

To move Qdrant storage to a different directory:

1. **Stop Qdrant:**
   ```bash
   scripts/qdrant/stop_qdrant.sh
   ```

2. **Update [`qdrant_config.yaml`](file:///Users/cornelius/dev/lennyhub-rag/qdrant_config.yaml):**
   ```yaml
   storage:
     storage_path: /new/path/to/storage
   ```

3. **Move data:**
   ```bash
   mv storage/qdrant /new/path/to/storage
   ```

4. **Restart Qdrant:**
   ```bash
   scripts/qdrant/start_qdrant.sh
   ```

## Version Control Considerations

> [!WARNING]
> Vector databases can grow large and contain binary data that doesn't compress well in Git.

**Current approach:**
- `storage/qdrant/` should be in `.gitignore`
- Use separate backup strategy (snapshots or directory copies)
- Only version control configuration files

**If you must version control:**
```bash
# Add only configuration files
git add storage/qdrant/collections/*/config.json
git add storage/qdrant/raft_state.json
```

## Monitoring Storage

### Check Collection Sizes

```bash
# Size of each collection
du -sh storage/qdrant/collections/*

# Total Qdrant storage
du -sh storage/qdrant/
```

### View Collection Info via API

```bash
# Get collection details
curl "http://localhost:6333/collections/lightrag_vdb_chunks_text_embedding_3_small_1536d"

# List all collections
curl "http://localhost:6333/collections"
```

### Check Disk Usage

```bash
# Monitor disk space
df -h storage/qdrant/

# Watch for growth
watch -n 60 'du -sh storage/qdrant/'
```

## Troubleshooting

### Corrupted Data

If Qdrant fails to start due to corrupted data:

1. **Check logs:**
   ```bash
   tail -f storage/qdrant/qdrant.log
   ```

2. **Restore from backup:**
   ```bash
   scripts/qdrant/stop_qdrant.sh
   rm -rf storage/qdrant/
   tar -xzf qdrant-backup-latest.tar.gz
   scripts/qdrant/start_qdrant.sh
   ```

3. **Rebuild from source data:**
   ```bash
   # If you have the original transcripts
   rm -rf storage/qdrant/
   python scripts/setup_rag.py --source-dir data/lennys-podcast --parallel
   ```

### Out of Disk Space

```bash
# Check what's using space
du -sh storage/qdrant/collections/*/0/segments/*

# Optimize collections (triggers segment merging)
curl -X POST "http://localhost:6333/collections/lightrag_vdb_chunks_text_embedding_3_small_1536d/optimizer"
```

### WAL Growing Too Large

```bash
# Check WAL size
du -sh storage/qdrant/collections/*/0/wal/

# Force flush to segments
curl -X POST "http://localhost:6333/collections/lightrag_vdb_chunks_text_embedding_3_small_1536d/optimizer"
```

## Best Practices

1. **Regular Backups**
   - Create daily snapshots via cron
   - Keep at least 7 days of backups
   - Test restore procedure periodically

2. **Monitor Disk Space**
   - Set up alerts for 80% disk usage
   - Plan for 3x growth of current data

3. **Graceful Shutdown**
   - Always use `scripts/qdrant/stop_qdrant.sh`
   - Never kill the process forcefully unless necessary

4. **Separate Storage**
   - Consider mounting `storage/qdrant/` on a separate disk
   - Use SSD for better performance

5. **Backup Before Major Changes**
   - Before upgrading Qdrant
   - Before running large batch operations
   - Before schema migrations

## Related Documentation

- [User Guide](file:///Users/cornelius/dev/lennyhub-rag/docs/USER_GUIDE.md) - Getting started with the system
- [Technical Reference](file:///Users/cornelius/dev/lennyhub-rag/docs/TECHNICAL_REFERENCE.md) - Architecture details
- [Qdrant Official Docs](https://qdrant.tech/documentation/concepts/storage/) - Detailed storage internals
